name: ðŸš€ ARM Cross-Compilation Matrix

on:
  push:
    branches: [ master, main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  cross-compile-arm:
    name: "âš™ï¸ ${{ matrix.config.name }}"
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        config:
          # Raspberry Pi Zero/Zero W (ARMv6)
          - name: "Pi Zero"
            arch: "armv6"
            cc: "arm-linux-gnueabi-gcc"
            cxx: "arm-linux-gnueabi-g++"
            cflags: "-march=armv6 -mfpu=vfp -mfloat-abi=softfp -O2"
            target: "pi-zero"
            
          # Raspberry Pi 3/4 (ARMv7)
          - name: "Pi 3/4"
            arch: "armv7"
            cc: "arm-linux-gnueabihf-gcc"
            cxx: "arm-linux-gnueabihf-g++"
            cflags: "-march=armv7-a -mfpu=neon-vfpv4 -mfloat-abi=hard -O2"
            target: "pi3-4"
            
          # ARM64/AArch64 (Pi 4 64-bit, etc.)
          - name: "ARM64"
            arch: "aarch64"
            cc: "aarch64-linux-gnu-gcc"
            cxx: "aarch64-linux-gnu-g++"
            cflags: "-march=armv8-a -O2"
            target: "arm64"
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ Install Cross-Compilation Tools
      run: |
        sudo apt-get update
        
        if [ "${{ matrix.config.arch }}" = "aarch64" ]; then
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            libc6-dev-arm64-cross
        else
          sudo apt-get install -y \
            gcc-arm-linux-gnueabi \
            g++-arm-linux-gnueabi \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            libc6-dev-armhf-cross \
            libc6-armel-cross \
            libc6-dev-armel-cross
        fi
        
        sudo apt-get install -y build-essential cmake pkg-config
        
    - name: âš™ï¸ Configure Build Environment
      run: |
        # Set compiler variables
        echo "CC=${{ matrix.config.cc }}" >> $GITHUB_ENV
        echo "CXX=${{ matrix.config.cxx }}" >> $GITHUB_ENV
        echo "AR=${{ matrix.config.cc }}-ar" >> $GITHUB_ENV
        
        # Set correct strip command based on architecture
        if [ "${{ matrix.config.arch }}" = "aarch64" ]; then
          echo "STRIP=aarch64-linux-gnu-strip" >> $GITHUB_ENV
        elif [ "${{ matrix.config.arch }}" = "armv6" ]; then
          echo "STRIP=arm-linux-gnueabi-strip" >> $GITHUB_ENV
        else
          echo "STRIP=arm-linux-gnueabihf-strip" >> $GITHUB_ENV
        fi
        
        # Set compilation flags
        echo "CFLAGS=${{ matrix.config.cflags }}" >> $GITHUB_ENV
        echo "CXXFLAGS=${{ matrix.config.cflags }} -std=c++11" >> $GITHUB_ENV
        echo "LDFLAGS=${{ matrix.config.cflags }}" >> $GITHUB_ENV
        
        # Display configuration
        echo "ðŸŽ¯ Target: ${{ matrix.config.name }} (${{ matrix.config.arch }})"
        echo "ðŸ”§ Compiler: ${{ matrix.config.cc }}"
        echo "ðŸ—ï¸ Flags: ${{ matrix.config.cflags }}"
        
    - name: ðŸ—ï¸ Build Simple Version
      run: |
        # Clean previous builds
        make clean || true
        
        # Build simple version
        if make simple \
          CC="${{ matrix.config.cc }}" \
          CXX="${{ matrix.config.cxx }}" \
          CXXFLAGS="${{ matrix.config.cflags }} -std=c++11" \
          LDFLAGS="${{ matrix.config.cflags }}"; then
          
          echo "âœ… Simple version built successfully"
          ls -lh motion-detector-simple
          file motion-detector-simple
        else
          echo "âŒ Simple version build failed"
          exit 1
        fi
        
    - name: ðŸš€ Build Advanced Version
      continue-on-error: true
      run: |
        # Add optimization flags based on architecture
        EXTRA_FLAGS=""
        case "${{ matrix.config.arch }}" in
          "armv6")
            EXTRA_FLAGS="-ftree-vectorize"
            ;;
          "armv7")
            EXTRA_FLAGS="-ftree-vectorize -ffast-math"
            ;;
          "aarch64")
            EXTRA_FLAGS="-ftree-vectorize -ffast-math"
            ;;
        esac
        
        if make advanced \
          CC="${{ matrix.config.cc }}" \
          CXX="${{ matrix.config.cxx }}" \
          CXXFLAGS="${{ matrix.config.cflags }} -std=c++11 $EXTRA_FLAGS" \
          LDFLAGS="${{ matrix.config.cflags }}"; then
          
          echo "âœ… Advanced version built successfully"
          ls -lh motion-detector
          file motion-detector
        else
          echo "âš ï¸ Advanced version build failed - continuing with simple version"
        fi
        
    - name: ðŸ”— Build Static Version
      continue-on-error: true
      run: |
        # Add optimization flags based on architecture
        EXTRA_FLAGS=""
        case "${{ matrix.config.arch }}" in
          "armv6")
            EXTRA_FLAGS="-ftree-vectorize"
            ;;
          "armv7")
            EXTRA_FLAGS="-ftree-vectorize -ffast-math"
            ;;
          "aarch64")
            EXTRA_FLAGS="-ftree-vectorize -ffast-math"
            ;;
        esac
        
        if make static \
          CC="${{ matrix.config.cc }}" \
          CXX="${{ matrix.config.cxx }}" \
          CXXFLAGS="${{ matrix.config.cflags }} -std=c++11 $EXTRA_FLAGS" \
          LDFLAGS="${{ matrix.config.cflags }}"; then
          
          echo "âœ… Static version built successfully"
          ls -lh motion-detector-static
          file motion-detector-static
          echo "ðŸ“Š Static binary info:"
          ldd motion-detector-static 2>&1 || echo "  âœ“ Fully static binary (no dynamic dependencies)"
        else
          echo "âš ï¸ Static version build failed - continuing without static version"
        fi
        
    - name: ðŸ“ Build Pi Zero Debug Version
      if: matrix.config.arch == 'armv6'
      continue-on-error: true
      run: |
        echo "ðŸ”§ Building Pi Zero debug version (ARMv6 only)..."
        
        if make pi-debug \
          CC="${{ matrix.config.cc }}" \
          CXX="${{ matrix.config.cxx }}" \
          CXXFLAGS="${{ matrix.config.cflags }} -std=c++11" \
          LDFLAGS="${{ matrix.config.cflags }}"; then
          
          echo "âœ… Pi Zero debug version built successfully"
          ls -lh motion-detector-pi-debug
          file motion-detector-pi-debug
          echo "ðŸ“Š Pi Zero debug features:"
          echo "  âœ“ Conservative memory limits"
          echo "  âœ“ DC-only mode disabled for stability"
          echo "  âœ“ Segfault debugging enabled"
          echo "  âœ“ Image size safety checks"
          echo "  âœ“ ARM alignment fixes"
        else
          echo "âš ï¸ Pi Zero debug version build failed"
        fi
        
    - name: ðŸ§ª Verify Binary Compatibility
      run: |
        # Check simple version
        if [ -f "motion-detector-simple" ]; then
          echo "ðŸ“‹ Simple version info:"
          file motion-detector-simple
          readelf -h motion-detector-simple | grep -E "(Machine|Flags|Class)" || true
          echo ""
        fi
        
        # Check advanced version
        if [ -f "motion-detector" ]; then
          echo "ðŸ“‹ Advanced version info:"
          file motion-detector
          readelf -h motion-detector | grep -E "(Machine|Flags|Class)" || true
          echo ""
        fi
        
        # Check static version
        if [ -f "motion-detector-static" ]; then
          echo "ðŸ“‹ Static version info:"
          file motion-detector-static
          readelf -h motion-detector-static | grep -E "(Machine|Flags|Class)" || true
          echo "ðŸ“Š Dependencies check:"
          ldd motion-detector-static 2>&1 || echo "  âœ“ No dynamic dependencies (fully static)"
          echo ""
        fi
        
        # Check Pi Zero debug version (ARMv6 only)
        if [ -f "motion-detector-pi-debug" ]; then
          echo "ðŸ“‹ Pi Zero debug version info:"
          file motion-detector-pi-debug
          readelf -h motion-detector-pi-debug | grep -E "(Machine|Flags|Class)" || true
          echo "ðŸ“ Pi Zero optimizations:"
          echo "  âœ“ ARMv6 soft-float compatible"
          echo "  âœ“ Conservative memory usage"
          echo "  âœ“ Segfault protection enabled"
          echo ""
        fi
        
    - name: ðŸ“¦ Create Release Package
      run: |
        # Create target directory
        PKG_DIR="motion-detector-${{ matrix.config.target }}"
        mkdir -p "$PKG_DIR"
        
        # Strip and copy binaries
        if [ -f "motion-detector-simple" ]; then
          $STRIP motion-detector-simple
          cp motion-detector-simple "$PKG_DIR/"
          echo "âœ… Simple version packaged and stripped"
        fi
        
        if [ -f "motion-detector" ]; then
          $STRIP motion-detector
          cp motion-detector "$PKG_DIR/motion-detector-advanced"
          echo "âœ… Advanced version packaged and stripped"
        fi
        
        if [ -f "motion-detector-static" ]; then
          $STRIP motion-detector-static
          cp motion-detector-static "$PKG_DIR/"
          echo "âœ… Static version packaged and stripped"
        fi
        
        if [ -f "motion-detector-pi-debug" ]; then
          $STRIP motion-detector-pi-debug
          cp motion-detector-pi-debug "$PKG_DIR/"
          echo "âœ… Pi Zero debug version packaged and stripped"
        fi
        
        # Copy documentation and scripts
        cp README.md "$PKG_DIR/" || true
        cp build_for_pi.sh "$PKG_DIR/" || true
        cp PI_ZERO_FIX.md "$PKG_DIR/" || true
        
        # Copy Pi Zero specific test script for ARMv6 builds
        if [ "${{ matrix.config.arch }}" = "armv6" ] && [ -f "tests/pi_zero_debug_test.sh" ]; then
          mkdir -p "$PKG_DIR/tests"
          cp tests/pi_zero_debug_test.sh "$PKG_DIR/tests/"
          echo "âœ… Pi Zero debug test script included"
        fi
        
        # Create target-specific installation script
        cat > "$PKG_DIR/install.sh" << EOF
        #!/bin/bash
        echo "ðŸŽ¯ Motion Detector - ${{ matrix.config.name }} Installation"
        echo "======================================================"
        
        # Architecture check
        EXPECTED_ARCH="${{ matrix.config.arch }}"
        CURRENT_ARCH=\$(uname -m)
        
        echo "Current architecture: \$CURRENT_ARCH"
        echo "Package architecture: \$EXPECTED_ARCH"
        
        # Install binaries
        if [ -f "motion-detector-simple" ]; then
          sudo cp motion-detector-simple /usr/local/bin/motion-detector
          sudo chmod +x /usr/local/bin/motion-detector
          echo "âœ… Installed motion-detector-simple to /usr/local/bin/motion-detector"
        fi
        
        if [ -f "motion-detector-advanced" ]; then
          sudo cp motion-detector-advanced /usr/local/bin/motion-detector-advanced
          sudo chmod +x /usr/local/bin/motion-detector-advanced
          echo "âœ… Installed motion-detector-advanced to /usr/local/bin/motion-detector-advanced"
        fi
        
        if [ -f "motion-detector-static" ]; then
          sudo cp motion-detector-static /usr/local/bin/motion-detector-static
          sudo chmod +x /usr/local/bin/motion-detector-static
          echo "âœ… Installed motion-detector-static to /usr/local/bin/motion-detector-static"
        fi
        
        if [ -f "motion-detector-pi-debug" ]; then
          sudo cp motion-detector-pi-debug /usr/local/bin/motion-detector-pi-debug
          sudo chmod +x /usr/local/bin/motion-detector-pi-debug
          echo "âœ… Installed motion-detector-pi-debug to /usr/local/bin/motion-detector-pi-debug"
          echo "   ðŸ“ Pi Zero specific version with segfault protection"
        fi
        
        echo ""
        echo "ðŸš€ Installation complete!"
        echo "Test with: motion-detector img1.jpg img2.jpg -g -s 2 -v"
        
        if [ -f "tests/pi_zero_debug_test.sh" ]; then
          echo ""
          echo "ðŸ“ Pi Zero users: Run comprehensive test with:"
          echo "   cd tests && ./pi_zero_debug_test.sh"
          echo "   See PI_ZERO_FIX.md for troubleshooting guide"
        fi
        EOF
        
        chmod +x "$PKG_DIR/install.sh"
        
        # Create target-specific README
        cat > "$PKG_DIR/README-${{ matrix.config.target }}.md" << EOF
        # Motion Detector - ${{ matrix.config.name }} Build
        
        ## Target Information
        - **Platform**: ${{ matrix.config.name }}
        - **Architecture**: ${{ matrix.config.arch }}
        - **Compiler**: ${{ matrix.config.cc }}
        - **Optimization**: ${{ matrix.config.cflags }}
        
        ## Available Versions
        
        ### Simple Version (motion-detector-simple)
        - Maximum compatibility
        - Uses standard libraries
        - Recommended for most users
        
        ### Advanced Version (motion-detector-advanced)
        - Optimized for ${{ matrix.config.name }}
        - Platform-specific optimizations
        - Better performance
        
        ### Static Version (motion-detector-static)
        - **Fully portable** - no dependencies
        - Can run on any ${{ matrix.config.name }} device
        - Larger file size but maximum compatibility
        - **Recommended for deployment**
        
        ### Pi Zero Debug Version (motion-detector-pi-debug) ðŸ“
        - **Pi Zero W/Zero 2 W specific** (ARMv6 only)
        - Segfault protection and conservative memory usage
        - DC-only mode disabled for stability
        - Image size safety checks
        - **Recommended for Pi Zero troubleshooting**
        
        ## Installation
        \`\`\`bash
        ./install.sh
        \`\`\`
        
        ## Usage
        \`\`\`bash
        # Basic usage (simple version)
        motion-detector image1.jpg image2.jpg -v
        
        # Optimized for ${{ matrix.config.name }} (advanced version)
        motion-detector-advanced image1.jpg image2.jpg -g -s 2 --benchmark
        
        # Portable static version (works everywhere)
        motion-detector-static image1.jpg image2.jpg -g -s 2 -v
        
        # Pi Zero debug version (ARMv6 only, segfault protection)
        motion-detector-pi-debug image1.jpg image2.jpg -s 8 -g -v
        \`\`\`
        
        ## Performance Notes
        - **Simple**: Maximum compatibility, standard performance
        - **Advanced**: Platform-optimized, best performance
        - **Static**: Portable, good performance, no dependencies
        - **Pi Zero Debug**: Conservative settings, segfault protection, stability-focused
        
        ## Deployment Recommendation
        Use **motion-detector-static** for production deployment as it has no external dependencies.
        EOF
        
        # Show package contents
        echo "ðŸ“¦ Package contents for ${{ matrix.config.name }}:"
        ls -la "$PKG_DIR"
        
        # Create tarball
        tar -czf "$PKG_DIR.tar.gz" "$PKG_DIR"
        echo "âœ… Created $PKG_DIR.tar.gz"
        
    - name: ðŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: motion-detector-${{ matrix.config.target }}
        path: motion-detector-${{ matrix.config.target }}.tar.gz
        retention-days: 30
        
    - name: ðŸŽ‰ Build Summary
      run: |
        echo "ðŸ“Š Build Summary for ${{ matrix.config.name }}:"
        echo "=============================================="
        
        if [ -f "motion-detector-${{ matrix.config.target }}/motion-detector-simple" ]; then
          SIZE=$(ls -lh motion-detector-${{ matrix.config.target }}/motion-detector-simple | awk '{print $5}')
          echo "âœ… Simple version: $SIZE"
        fi
        
        if [ -f "motion-detector-${{ matrix.config.target }}/motion-detector-advanced" ]; then
          SIZE=$(ls -lh motion-detector-${{ matrix.config.target }}/motion-detector-advanced | awk '{print $5}')
          echo "âœ… Advanced version: $SIZE"
        fi
        
        if [ -f "motion-detector-${{ matrix.config.target }}/motion-detector-static" ]; then
          SIZE=$(ls -lh motion-detector-${{ matrix.config.target }}/motion-detector-static | awk '{print $5}')
          echo "âœ… Static version: $SIZE (portable)"
        fi
        
        echo ""
        echo "ðŸŽ¯ Target: ${{ matrix.config.name }} (${{ matrix.config.arch }})"
        echo "ðŸ“¦ Package: motion-detector-${{ matrix.config.target }}.tar.gz"
        echo "ðŸš€ Ready for deployment!"
        
    - name: ðŸ“¥ Download Instructions
      run: |
        echo ""
        echo "ðŸ”— DOWNLOAD LINKS:"
        echo "=================="
        echo ""
        echo "1ï¸âƒ£ Go to GitHub Actions page:"
        echo "   ðŸ‘‰ https://github.com/${{ github.repository }}/actions"
        echo ""
        echo "2ï¸âƒ£ Click on this workflow run:"
        echo "   ðŸ‘‰ https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "3ï¸âƒ£ Scroll down to 'Artifacts' section and download:"
        echo "   ðŸ“¦ motion-detector-${{ matrix.config.target }}.tar.gz"
        echo ""
        echo "4ï¸âƒ£ Or use direct download command:"
        echo "   curl -L -H \"Authorization: token YOUR_TOKEN\" \\"
        echo "        -H \"Accept: application/vnd.github.v3+json\" \\"
        echo "        https://api.github.com/repos/${{ github.repository }}/actions/artifacts/ARTIFACT_ID/zip"
        echo ""
        echo "ðŸ“‹ Package contains:"
        echo "   â€¢ motion-detector-simple (recommended)"
        echo "   â€¢ motion-detector-advanced (if built successfully)"
        echo "   â€¢ motion-detector-static (portable, no dependencies)"
        echo "   â€¢ install.sh (automated installer)"
        echo "   â€¢ README-${{ matrix.config.target }}.md (platform guide)"
        echo ""
        echo "ðŸš€ Quick install on target device:"
        echo "   tar -xzf motion-detector-${{ matrix.config.target }}.tar.gz"
        echo "   cd motion-detector-${{ matrix.config.target }}"
        echo "   ./install.sh"

  # Summary job that runs after all builds complete
  download-summary:
    name: "ðŸ“¥ Download Summary"
    runs-on: ubuntu-latest
    needs: cross-compile-arm
    if: always()
    
    steps:
    - name: ðŸ“‹ All Artifacts Summary
      run: |
        echo ""
        echo "ðŸš€ MOTION DETECTOR - ARM CROSS-COMPILATION COMPLETE!"
        echo "====================================================="
        echo ""
        echo "ðŸ“¦ Available Downloads:"
        echo "----------------------"
        echo "â€¢ motion-detector-pi-zero    (Raspberry Pi Zero/Zero W)"
        echo "â€¢ motion-detector-pi3-4      (Raspberry Pi 3/4 32-bit)"  
        echo "â€¢ motion-detector-arm64      (ARM64/AArch64 64-bit)"
        echo ""
        echo "ðŸ”— HOW TO DOWNLOAD:"
        echo "==================="
        echo ""
        echo "1ï¸âƒ£ Visit this workflow run:"
        echo "   ðŸ‘‰ https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "2ï¸âƒ£ Scroll to 'Artifacts' section at the bottom"
        echo ""
        echo "3ï¸âƒ£ Click to download the package for your platform:"
        echo "   ðŸ“± Pi Zero:  motion-detector-pi-zero.tar.gz"
        echo "   ðŸ“ Pi 3/4:   motion-detector-pi3-4.tar.gz"
        echo "   ðŸ’ª ARM64:    motion-detector-arm64.tar.gz"
        echo ""
        echo "ðŸ“‹ Each package contains:"
        echo "   âœ… Pre-compiled binaries (simple + advanced + static versions)"
        echo "   âœ… Automated install script (./install.sh)"
        echo "   âœ… Platform-specific documentation"
        echo "   âœ… Build scripts and Makefile"
        echo ""
        echo "ðŸš€ Installation on target device:"
        echo "   tar -xzf motion-detector-PLATFORM.tar.gz"
        echo "   cd motion-detector-PLATFORM/"
        echo "   ./install.sh"
        echo ""
        echo "ðŸ§ª Test your installation:"
        echo "   motion-detector img1.jpg img2.jpg -g -s 2 -v"
        echo ""
        echo "ðŸ’¡ Version recommendations:"
        echo "   â€¢ Simple: Maximum compatibility, standard performance"
        echo "   â€¢ Advanced: Platform-optimized, best performance"  
        echo "   â€¢ Static: Portable, no dependencies, recommended for deployment"
        echo ""
        echo "ðŸŽ¯ Performance tips:"
        echo "   â€¢ Pi Zero: Use -s 2 or -s 3 for better performance"
        echo "   â€¢ Pi 3/4:  Try advanced version with --benchmark"
        echo "   â€¢ ARM64:   Use -d flag for DC-only JPEG mode" 